{% extends "base.html" %}
{% block title %}Network — CS Community{% endblock %}

{% block extra_head %}
<style>
    /* ── Layout ── */
    .filter-sidebar {
        position: sticky;
        top: 80px;
    }

    /* ── Search bar ── */
    .search-wrap {
        position: relative;
    }

    .search-wrap .fa-magnifying-glass {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 0.9rem;
        pointer-events: none;
    }

    .search-wrap input {
        padding-left: 2.5rem;
        border-radius: 50px !important;
        border: 1.5px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-main);
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-wrap input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.12);
    }

    /* ── Filter track links ── */
    .track-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.84rem;
        font-weight: 500;
        color: var(--text-muted);
        text-decoration: none;
        transition: background 0.15s, color 0.15s;
    }

    .track-option:hover {
        background: rgba(37, 99, 235, 0.06);
        color: var(--accent-color);
    }

    .track-option.active-track {
        background: rgba(37, 99, 235, 0.1);
        color: var(--accent-color);
        font-weight: 600;
    }

    .track-icon {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        background: rgba(37, 99, 235, 0.08);
        flex-shrink: 0;
    }

    /* ── User card ── */
    .user-card {
        border-radius: 14px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        transition: box-shadow 0.2s, transform 0.2s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .user-card:hover {
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .user-card-banner {
        height: 52px;
        background: linear-gradient(135deg, var(--accent-color) 0%, #60a5fa 100%);
    }

    .user-card-body {
        padding: 0 1.1rem 1.1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .user-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--card-bg);
        margin-top: -32px;
        display: block;
        background: var(--card-bg);
    }

    .badge-avail {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
        border: 1px solid rgba(34, 197, 94, 0.25);
        border-radius: 50px;
        font-size: 0.72rem;
        font-weight: 600;
        padding: 2px 10px;
        white-space: nowrap;
    }

    .skill-chip {
        background: rgba(37, 99, 235, 0.07);
        color: var(--accent-color);
        border: 1px solid rgba(37, 99, 235, 0.15);
        border-radius: 50px;
        font-size: 0.72rem;
        font-weight: 500;
        padding: 2px 10px;
    }

    /* ── Active filter badge ── */
    .filter-badge {
        background: rgba(37, 99, 235, 0.08);
        border: 1px solid rgba(37, 99, 235, 0.2);
        border-radius: 50px;
        padding: 4px 12px;
        font-size: 0.78rem;
        font-weight: 600;
        color: var(--accent-color);
        display: inline-flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
    }

    .filter-badge .remove {
        font-size: 0.9em;
        opacity: 0.6;
    }

    .filter-badge .remove:hover {
        opacity: 1;
    }

    /* ── Result count ── */
    .result-count {
        font-size: 0.82rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    /* ── Highlight matched text ── */
    mark {
        background: rgba(37, 99, 235, 0.15);
        color: var(--accent-color);
        border-radius: 3px;
        padding: 0 2px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">

    <!-- ── Left: Filter sidebar ── -->
    <div class="col-lg-3 d-none d-lg-block">
        <div class="card p-3 shadow-sm filter-sidebar">

            <h6 class="fw-bold mb-1 d-flex align-items-center gap-2">
                <i class="fas fa-sliders" style="color:var(--accent-color);"></i>
                Filters
            </h6>
            <p class="text-muted mb-3" style="font-size:0.74rem;">Narrow down by track or status</p>

            <!-- Track -->
            <p class="small fw-semibold text-muted mb-2 text-uppercase"
                style="font-size:0.68rem; letter-spacing:.06em;">
                Specialization
            </p>

            {% set tracks = [
            ('Web Development', 'fa-globe', '#2563eb'),
            ('Mobile App', 'fa-mobile-screen', '#7c3aed'),
            ('Data Science', 'fa-chart-bar', '#0891b2'),
            ('AI & Machine Learning', 'fa-brain', '#d97706'),
            ('Cybersecurity', 'fa-shield-halved', '#dc2626'),
            ('Game Development', 'fa-gamepad', '#16a34a'),
            ('Embedded Systems', 'fa-microchip', '#78716c'),
            ('Other', 'fa-ellipsis', '#6b7280'),
            ] %}

            {% for track_name, icon, color in tracks %}
            <a href="{{ url_for('network', track=track_name,
                          available=avail_filter if avail_filter else '',
                          search=search_q if search_q else '') }}"
                class="track-option {{ 'active-track' if track_filter == track_name }}" {% if track_filter==track_name
                %}style="color:{{ color }};" {% endif %}>
                <span class="track-icon" {% if track_filter==track_name
                    %}style="background:{{ color }}15; color:{{ color }};" {% endif %}>
                    <i class="fas {{ icon }}"></i>
                </span>
                {{ track_name }}
                {% if track_filter == track_name %}
                <i class="fas fa-check ms-auto" style="font-size:0.68rem;"></i>
                {% endif %}
            </a>
            {% endfor %}

            <hr class="my-3 opacity-25">

            <!-- Availability toggle -->
            <p class="small fw-semibold text-muted mb-2 text-uppercase"
                style="font-size:0.68rem; letter-spacing:.06em;">
                Availability
            </p>
            <a href="{{ url_for('network',
                          track=track_filter if track_filter else '',
                          available='' if avail_filter == 'yes' else 'yes',
                          search=search_q if search_q else '') }}"
                class="track-option {{ 'active-track' if avail_filter == 'yes' }}" {% if avail_filter=='yes'
                %}style="color:#16a34a;" {% endif %}>
                <span class="track-icon" {% if avail_filter=='yes'
                    %}style="background:rgba(34,197,94,0.12); color:#16a34a;" {% endif %}>
                    <i class="fas fa-circle-check"></i>
                </span>
                Open for Project
                {% if avail_filter == 'yes' %}
                <i class="fas fa-check ms-auto" style="font-size:0.68rem;"></i>
                {% endif %}
            </a>

            <!-- Clear all -->
            {% if track_filter or avail_filter or search_q %}
            <div class="mt-3">
                <a href="{{ url_for('network') }}" class="btn btn-sm btn-outline-danger w-100 rounded-pill fw-semibold">
                    <i class="fas fa-xmark me-1"></i>Clear All Filters
                </a>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- ── Main: Discovery ── -->
    <div class="col-lg-9">

        <!-- Page header row -->
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
            <div>
                <h4 class="fw-bold mb-0" style="font-size:1.15rem;">
                    <i class="fas fa-users me-2" style="color:var(--accent-color);"></i>
                    Discover CS Students
                </h4>
                <p class="text-muted mb-0 result-count mt-1">
                    {% if total == 0 %}
                    No students found
                    {% elif total == 1 %}
                    1 student found
                    {% else %}
                    {{ total }} students found
                    {% endif %}
                    {% if track_filter %} in <strong>{{ track_filter }}</strong>{% endif %}
                    {% if avail_filter == 'yes' %} · <span style="color:#16a34a;">Available only</span>{% endif %}
                </p>
            </div>

            <!-- Search bar -->
            <form method="GET" action="{{ url_for('network') }}" class="search-wrap" style="width:260px;">
                <i class="fas fa-magnifying-glass"></i>
                <input type="text" name="search" class="form-control form-control-sm"
                    placeholder="Search name, skill, track…" value="{{ search_q }}" autocomplete="off">
                {% if track_filter %}
                <input type="hidden" name="track" value="{{ track_filter }}">
                {% endif %}
                {% if avail_filter %}
                <input type="hidden" name="available" value="{{ avail_filter }}">
                {% endif %}
            </form>
        </div>

        <!-- Active filter badges -->
        {% if search_q or track_filter or avail_filter %}
        <div class="d-flex flex-wrap gap-2 mb-3">
            {% if search_q %}
            <a href="{{ url_for('network', track=track_filter, available=avail_filter) }}" class="filter-badge">
                <i class="fas fa-magnifying-glass"></i>
                "{{ search_q }}"
                <span class="remove">&times;</span>
            </a>
            {% endif %}
            {% if track_filter %}
            <a href="{{ url_for('network', search=search_q, available=avail_filter) }}" class="filter-badge">
                <i class="fas fa-tag"></i>
                {{ track_filter }}
                <span class="remove">&times;</span>
            </a>
            {% endif %}
            {% if avail_filter == 'yes' %}
            <a href="{{ url_for('network', search=search_q, track=track_filter) }}" class="filter-badge"
                style="color:#16a34a; border-color:rgba(34,197,94,0.3); background:rgba(34,197,94,0.07);">
                <i class="fas fa-circle-check"></i>
                Available only
                <span class="remove">&times;</span>
            </a>
            {% endif %}
            <a href="{{ url_for('network') }}" class="text-danger small fw-semibold text-decoration-none ms-1"
                style="align-self:center; font-size:0.8rem;">
                Clear all
            </a>
        </div>
        {% endif %}

        <!-- User cards grid -->
        {% if users %}
        <div class="row g-3">
            {% for user in users %}
            <div class="col-md-6 col-xl-4">
                <div class="user-card h-100">
                    <!-- Banner -->
                    <div class="user-card-banner" style="background:linear-gradient(135deg,
                 hsl({{ loop.index0 * 37 % 360 }}, 70%, 45%) 0%,
                 hsl({{ (loop.index0 * 37 + 40) % 360 }}, 80%, 65%) 100%);"></div>

                    <div class="user-card-body">
                        <!-- Avatar row -->
                        <div class="d-flex align-items-end justify-content-between mb-2">
                            <img src="{{ profile_image_url(user.profile_image) }}" alt="{{ user.username }}"
                                onerror="this.src='{{ url_for('static', filename='uploads/profile_pics/default_profile.png') }}'"
                                class="user-avatar">
                            {% if user.available_for_project %}
                            <span class="badge-avail mb-1">
                                <i class="fas fa-circle me-1" style="font-size:0.45rem;"></i>Open for Project
                            </span>
                            {% endif %}
                        </div>

                        <!-- Name + track -->
                        <h6 class="fw-bold mb-0" style="font-size:0.95rem;">
                            {% if search_q and search_q.lower() in user.username.lower() %}
                            {{ user.username | replace(search_q, '<mark>' ~ search_q ~ '</mark>') | safe }}
                            {% else %}
                            {{ user.username }}
                            {% endif %}
                        </h6>
                        <p class="text-muted mb-2" style="font-size:0.78rem;">
                            <i class="fas fa-code-branch me-1"></i>{{ user.track or 'CS Student' }}
                        </p>

                        <!-- Skills chips (max 3) -->
                        {% if user.skills %}
                        <div class="d-flex flex-wrap gap-1 mb-3">
                            {% set skill_list = user.skills.split(',') %}
                            {% for skill in skill_list[:3] %}
                            <span class="skill-chip">{{ skill.strip() }}</span>
                            {% endfor %}
                            {% if skill_list | length > 3 %}
                            <span class="skill-chip"
                                style="background:rgba(0,0,0,0.04); color:var(--text-muted); border-color:var(--border-color);">
                                +{{ skill_list | length - 3 }}
                            </span>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="mb-3"></div>
                        {% endif %}

                        <!-- Action -->
                        <div class="mt-auto">
                            <a href="{{ url_for('profile', user_id=user.id) }}"
                                class="btn btn-sm btn-outline-primary w-100 rounded-pill fw-semibold">
                                <i class="fas fa-user me-1"></i>View Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination hint (if > 50) -->
        {% if total > 50 %}
        <p class="text-center text-muted mt-4" style="font-size:0.82rem;">
            Showing all {{ total }} results — use filters to narrow down.
        </p>
        {% endif %}

        {% else %}
        <!-- Empty state -->
        <div class="card text-center p-5 shadow-sm" style="border-radius:16px;">
            <i class="fas fa-user-slash text-muted mb-3" style="font-size:3rem; opacity:0.25;"></i>
            <h5 class="fw-bold text-muted mb-2">No students found</h5>
            <p class="text-muted small mb-3">
                {% if search_q %}
                No results for "<strong>{{ search_q }}</strong>".
                Try a different keyword or clear the search.
                {% elif track_filter or avail_filter %}
                No students match the current filters.
                {% else %}
                No other students have joined CS Community yet.
                {% endif %}
            </p>
            <a href="{{ url_for('network') }}" class="btn btn-outline-primary btn-sm rounded-pill px-4">
                <i class="fas fa-xmark me-1"></i>Reset Filters
            </a>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}